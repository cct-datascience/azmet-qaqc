<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>QA by Forecasting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="azmet-qaqc_files/libs/clipboard/clipboard.min.js"></script>
<script src="azmet-qaqc_files/libs/quarto-html/quarto.js"></script>
<script src="azmet-qaqc_files/libs/quarto-html/popper.min.js"></script>
<script src="azmet-qaqc_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="azmet-qaqc_files/libs/quarto-html/anchor.min.js"></script>
<link href="azmet-qaqc_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="azmet-qaqc_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="azmet-qaqc_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="azmet-qaqc_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="azmet-qaqc_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#problem-definition" id="toc-problem-definition" class="nav-link active" data-scroll-target="#problem-definition"> <span class="header-section-number">1</span> Problem Definition</a></li>
  <li><a href="#gathering-information" id="toc-gathering-information" class="nav-link" data-scroll-target="#gathering-information"> <span class="header-section-number">2</span> Gathering Information</a>
  <ul class="collapse">
  <li><a href="#retrieve-data" id="toc-retrieve-data" class="nav-link" data-scroll-target="#retrieve-data"> <span class="header-section-number">2.1</span> Retrieve Data</a></li>
  </ul></li>
  <li><a href="#preliminary-exploratory-analysis" id="toc-preliminary-exploratory-analysis" class="nav-link" data-scroll-target="#preliminary-exploratory-analysis"> <span class="header-section-number">3</span> Preliminary (exploratory) analysis</a>
  <ul class="collapse">
  <li><a href="#mean-air-temp" id="toc-mean-air-temp" class="nav-link" data-scroll-target="#mean-air-temp"> <span class="header-section-number">3.1</span> Mean Air Temp</a></li>
  <li><a href="#solar-radiation" id="toc-solar-radiation" class="nav-link" data-scroll-target="#solar-radiation"> <span class="header-section-number">3.2</span> Solar Radiation</a></li>
  <li><a href="#precipitation" id="toc-precipitation" class="nav-link" data-scroll-target="#precipitation"> <span class="header-section-number">3.3</span> Precipitation</a></li>
  </ul></li>
  <li><a href="#qa-workflow" id="toc-qa-workflow" class="nav-link" data-scroll-target="#qa-workflow"> <span class="header-section-number">4</span> QA workflow</a></li>
  <li><a href="#sec-forecasting" id="toc-sec-forecasting" class="nav-link" data-scroll-target="#sec-forecasting"> <span class="header-section-number">5</span> Learning about forecasting</a>
  <ul class="collapse">
  <li><a href="#timeseries-decomposition" id="toc-timeseries-decomposition" class="nav-link" data-scroll-target="#timeseries-decomposition"> <span class="header-section-number">5.1</span> Timeseries decomposition</a></li>
  <li><a href="#timeseries-features" id="toc-timeseries-features" class="nav-link" data-scroll-target="#timeseries-features"> <span class="header-section-number">5.2</span> Timeseries Features</a></li>
  <li><a href="#timeseries-models" id="toc-timeseries-models" class="nav-link" data-scroll-target="#timeseries-models"> <span class="header-section-number">5.3</span> Timeseries Models</a></li>
  <li><a href="#forecasting-methods" id="toc-forecasting-methods" class="nav-link" data-scroll-target="#forecasting-methods"> <span class="header-section-number">5.4</span> Forecasting methods</a></li>
  <li><a href="#modelforecast-diagnostics" id="toc-modelforecast-diagnostics" class="nav-link" data-scroll-target="#modelforecast-diagnostics"> <span class="header-section-number">5.5</span> Model/forecast diagnostics</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">QA by Forecasting</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("cct-datascience/azmetr")</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(azmetr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tsibble)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(feasts)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fable)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="problem-definition" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Problem Definition</h1>
<p>We want to use forecasts to do quality assurance of AZMet weather data. Use the existing timeseries available from the API (and possibly also historical data not on the API) to forecast the current day’s (or hour’s) data with prediction interval(s). Data that falls outside of those prediction interval(s) will get flagged as extreme values and possibly interpolated. Variables that need QA include:</p>
<ul>
<li>precipitation</li>
<li>air temperature</li>
<li>soil temperature</li>
<li>solar radiation</li>
<li>wind speed</li>
<li>humidity</li>
</ul>
<p>Other variables are (probably?) derived</p>
</section>
<section id="gathering-information" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Gathering Information</h1>
<section id="retrieve-data" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="retrieve-data"><span class="header-section-number">2.1</span> Retrieve Data</h2>
<p>Download all the daily data available from the API.</p>
<div class="cell" data-hash="azmet-qaqc_cache/html/import-data_ac7fb52c39d22b68816e009b095f78ad">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#read in historic data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>daily_hist <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"daily_hist.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 177749 Columns: 30
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr   (2): meta_station_id, meta_station_name
dbl  (27): date_year, date_doy, temp_air_maxC, temp_air_minC, temp_air_meanC...
date  (1): datetime

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get data from end of historic data until 2022-10-19</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"daily-2022-10-19.rds"</span>))) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  daily <span class="ot">&lt;-</span> <span class="fu">az_daily</span>(<span class="at">start_date =</span> <span class="fu">max</span>(daily_hist<span class="sc">$</span>datetime) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">end_date =</span> <span class="st">"2022-10-19"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#save these data</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_rds</span>(daily, <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"daily-2022-10-19.rds"</span>))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in already existing data, extract last date, retrieve data since that date</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>daily_old <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"daily-2022-10-19.rds"</span>))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>lastdate <span class="ot">&lt;-</span> <span class="fu">max</span>(daily_old<span class="sc">$</span>datetime)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>daily_new <span class="ot">&lt;-</span> <span class="fu">az_daily</span>(<span class="at">start_date =</span> lastdate <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(daily_old, daily_new)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">#join to historic data</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(daily_hist, daily) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Find and resolve duplicates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">duplicates</span>(daily, <span class="at">key =</span> <span class="fu">c</span>(meta_station_id, meta_station_name), <span class="at">index =</span> datetime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 170 × 69
   date_year date_doy datetime   temp_…¹ temp_…² temp_…³ relat…⁴ relat…⁵ relat…⁶
       &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1      2006      365 2006-12-31    17.8    -1.9     6     100      25.8    74.1
 2      2006      365 2006-12-31    17.8    -1.9     6     100      25.8    74.1
 3      2006      365 2006-12-31    19.8     1.7     9.6    69.9    21.4    48.1
 4      2006      365 2006-12-31    19.8     1.7     9.6    69.9    21.4    48.1
 5      2006      365 2006-12-31    20.3     0.9     9.3    78.7    18      50.8
 6      2006      365 2006-12-31    20.3     0.9     9.3    78.7    18      50.8
 7      2006      365 2006-12-31    15.1    -5.7     3.7    90.8    26.1    59.7
 8      2006      365 2006-12-31    15.1    -5.7     3.7    90.8    26.1    59.7
 9      2018      220 2018-08-08    36.7    24      29      66.1    24.5    46.7
10      2018      220 2018-08-08    36.7    24      29      66.1    24.5    46.7
# … with 160 more rows, 60 more variables: vp_deficit_mean &lt;dbl&gt;,
#   sol_rad_total &lt;dbl&gt;, precip_total_mm &lt;dbl&gt;, temp_soil_10cm_maxC &lt;dbl&gt;,
#   temp_soil_10cm_minC &lt;dbl&gt;, temp_soil_10cm_meanC &lt;dbl&gt;,
#   temp_soil_50cm_maxC &lt;dbl&gt;, temp_soil_50cm_minC &lt;dbl&gt;,
#   temp_soil_50cm_meanC &lt;dbl&gt;, wind_spd_mean_mps &lt;dbl&gt;,
#   wind_vector_magnitude &lt;dbl&gt;, wind_vector_dir &lt;dbl&gt;,
#   wind_vector_dir_stand_dev &lt;dbl&gt;, wind_spd_max_mps &lt;dbl&gt;, eto_azmet &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> daily <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">are_duplicated</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    daily,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">key =</span> <span class="fu">c</span>(meta_station_id, meta_station_name),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> datetime</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Convert to tsibble for exploration</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="ot">&lt;-</span> <span class="fu">as_tsibble</span>(daily, <span class="at">key =</span> <span class="fu">c</span>(meta_station_id, meta_station_name), <span class="at">index =</span> datetime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Any rows marked as needing review?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="sc">|&gt;</span> <span class="fu">filter</span>(meta_needs_review <span class="sc">!=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 131 x 69 [1D]
# Key:       meta_station_id, meta_station_name [29]
   date_year date_doy datetime   temp_…¹ temp_…² temp_…³ relat…⁴ relat…⁵ relat…⁶
       &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1      2022       94 2022-04-04    27.2   10.5     20.0    61.6   15.8     34.0
 2      2022       95 2022-04-05    31.0   10.2     21.7    61.3   13.0     31.1
 3      2022       96 2022-04-06    31.2   11.3     22.7    57.2    9.5     25.5
 4      2022       97 2022-04-07    33.4    7.70    20.9    47.7    3.32    17.4
 5      2022       98 2022-04-08    34.3    6.79    21.4    45.2    2.55    17.2
 6      2022       99 2022-04-09    33.6    9.42    23.8    36.6    3.76    12.7
 7      2022      100 2022-04-10    30.9   16.2     24.0    36.0    9       20.1
 8      2022      101 2022-04-11    29.9   17.6     23.5    40.8   12.7     26.7
 9      2022      174 2022-06-23    42.3   25.6     31.6    47.6   13.9     32.6
10      2022       67 2022-03-08    21.3    5.96    13.7    55.5    8.71    23.4
# … with 121 more rows, 60 more variables: vp_deficit_mean &lt;dbl&gt;,
#   sol_rad_total &lt;dbl&gt;, precip_total_mm &lt;dbl&gt;, temp_soil_10cm_maxC &lt;dbl&gt;,
#   temp_soil_10cm_minC &lt;dbl&gt;, temp_soil_10cm_meanC &lt;dbl&gt;,
#   temp_soil_50cm_maxC &lt;dbl&gt;, temp_soil_50cm_minC &lt;dbl&gt;,
#   temp_soil_50cm_meanC &lt;dbl&gt;, wind_spd_mean_mps &lt;dbl&gt;,
#   wind_vector_magnitude &lt;dbl&gt;, wind_vector_dir &lt;dbl&gt;,
#   wind_vector_dir_stand_dev &lt;dbl&gt;, wind_spd_max_mps &lt;dbl&gt;, eto_azmet &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Check extreme values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="sc">|&gt;</span> <span class="fu">filter</span>(temp_air_meanC <span class="sc">&gt;</span> <span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 67 x 69 [1D]
# Key:       meta_station_id, meta_station_name [13]
   date_year date_doy datetime   temp_…¹ temp_…² temp_…³ relat…⁴ relat…⁵ relat…⁶
       &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1      2015       14 2015-01-14   999       999     999     999     999     999
 2      2015       15 2015-01-15    19.4     999     999     999     999     999
 3      2017      204 2017-07-23   999       999     999     999     999     999
 4      2017      205 2017-07-24   999       999     999     999     999     999
 5      2017      206 2017-07-25   999       999     999     999     999     999
 6      2017      207 2017-07-26   999       999     999     999     999     999
 7      2017      208 2017-07-27   999       999     999     999     999     999
 8      2016      357 2016-12-22   999       999     999     999     999     999
 9      2016      358 2016-12-23   999       999     999     999     999     999
10      2016      359 2016-12-24   999       999     999     999     999     999
# … with 57 more rows, 60 more variables: vp_deficit_mean &lt;dbl&gt;,
#   sol_rad_total &lt;dbl&gt;, precip_total_mm &lt;dbl&gt;, temp_soil_10cm_maxC &lt;dbl&gt;,
#   temp_soil_10cm_minC &lt;dbl&gt;, temp_soil_10cm_meanC &lt;dbl&gt;,
#   temp_soil_50cm_maxC &lt;dbl&gt;, temp_soil_50cm_minC &lt;dbl&gt;,
#   temp_soil_50cm_meanC &lt;dbl&gt;, wind_spd_mean_mps &lt;dbl&gt;,
#   wind_vector_magnitude &lt;dbl&gt;, wind_vector_dir &lt;dbl&gt;,
#   wind_vector_dir_stand_dev &lt;dbl&gt;, wind_spd_max_mps &lt;dbl&gt;, eto_azmet &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Looks like historic data uses 999 for NA probably. I’ll set those to <code>NA</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="ot">&lt;-</span> daily_ts <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), \(x) <span class="fu">if_else</span>(x <span class="sc">==</span> <span class="dv">999</span>, <span class="cn">NA_real_</span>, x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Any gaps in the data?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="sc">|&gt;</span> <span class="fu">scan_gaps</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 268 x 3 [1D]
# Key:       meta_station_id, meta_station_name [13]
   meta_station_id meta_station_name datetime  
   &lt;chr&gt;           &lt;chr&gt;             &lt;date&gt;    
 1 az04            Safford           2009-01-17
 2 az08            Parker            2017-03-05
 3 az08            Parker            2017-03-06
 4 az08            Parker            2017-03-07
 5 az08            Parker            2017-03-08
 6 az08            Parker            2017-03-09
 7 az08            Parker            2017-03-10
 8 az08            Parker            2017-03-11
 9 az08            Parker            2019-02-26
10 az08            Parker            2019-02-27
# … with 258 more rows</code></pre>
</div>
</div>
<p>yes, let’s make them explicit NAs</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="ot">&lt;-</span> <span class="fu">fill_gaps</span>(daily_ts, <span class="at">.full =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check that gaps were made explicit:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"az23"</span>, <span class="st">"az14"</span>))<span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(datetime) <span class="sc">&gt;</span> <span class="dv">2018</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> datetime, <span class="at">y =</span> sol_rad_total)) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>meta_station_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="preliminary-exploratory-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Preliminary (exploratory) analysis</h1>
<p>I’ll start by looking at a subset of sites just to make visualization easier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="ot">&lt;-</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  daily_ts <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Aguila"</span>, <span class="st">"Harquahala"</span>, <span class="st">"Tucson"</span>, <span class="st">"Maricopa"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Is there missing data?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(meta_station_id, meta_station_name) <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'meta_station_id'. You can override using
the `.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 69
# Groups:   meta_station_id [4]
  meta_station…¹ meta_…² date_…³ date_…⁴ datet…⁵ temp_…⁶ temp_…⁷ temp_…⁸ relat…⁹
  &lt;chr&gt;          &lt;chr&gt;     &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
1 az01           Tucson        0       0       0       1       2       2       2
2 az06           Marico…       0       0       0       0       0       0       0
3 az07           Aguila        0       0       0       7       7      10      10
4 az23           Harqua…       2       2       0      12      12      12      12
# … with 60 more variables: relative_humidity_min &lt;int&gt;,
#   relative_humidity_mean &lt;int&gt;, vp_deficit_mean &lt;int&gt;, sol_rad_total &lt;int&gt;,
#   precip_total_mm &lt;int&gt;, temp_soil_10cm_maxC &lt;int&gt;,
#   temp_soil_10cm_minC &lt;int&gt;, temp_soil_10cm_meanC &lt;int&gt;,
#   temp_soil_50cm_maxC &lt;int&gt;, temp_soil_50cm_minC &lt;int&gt;,
#   temp_soil_50cm_meanC &lt;int&gt;, wind_spd_mean_mps &lt;int&gt;,
#   wind_vector_magnitude &lt;int&gt;, wind_vector_dir &lt;int&gt;, …</code></pre>
</div>
</div>
<p>Some variables are incomplete or have a short time gap. This may make forecasting difficult.</p>
<section id="mean-air-temp" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="mean-air-temp"><span class="header-section-number">3.1</span> Mean Air Temp</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(temp_air_meanC) <span class="sc">+</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Mean Air Temp (ºC)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Seasonality</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">gg_season</span>(temp_air_meanC) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Mean Air Temp (ºC)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Autocorrelation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(temp_air_meanC, <span class="at">lag_max =</span> <span class="dv">180</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="solar-radiation" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="solar-radiation"><span class="header-section-number">3.2</span> Solar Radiation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">autoplot</span>(sol_rad_total) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Total Solar Radiation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Seasonality</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">gg_season</span>(sol_rad_total) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Total Solar Radiation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Definitely some weird zeroes. Maybe a super cloudy day, but probably errors.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>daily_ts <span class="sc">|&gt;</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sol_rad_total <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(sol_rad_total)) <span class="sc">|&gt;</span> </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(datetime, sol_rad_total, meta_station_id, meta_needs_review) <span class="sc">|&gt;</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(sol_rad_total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 35 x 5 [1D]
# Key:       meta_station_id, meta_station_name [10]
   datetime   sol_rad_total meta_station_id meta_needs_review meta_station_name
   &lt;date&gt;             &lt;dbl&gt; &lt;chr&gt;                       &lt;dbl&gt; &lt;chr&gt;            
 1 2019-01-14             0 az14                           NA Yuma N. Gila     
 2 2021-02-04             0 az23                            0 Harquahala       
 3 2021-02-05             0 az23                            0 Harquahala       
 4 2021-02-06             0 az23                            0 Harquahala       
 5 2021-02-08             0 az23                            0 Harquahala       
 6 2021-02-09             0 az23                            0 Harquahala       
 7 2021-02-12             0 az23                            0 Harquahala       
 8 2021-02-13             0 az23                            0 Harquahala       
 9 2021-02-14             0 az23                            0 Harquahala       
10 2021-02-15             0 az23                            0 Harquahala       
# … with 25 more rows</code></pre>
</div>
</div>
<p>Autocorrelation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(sol_rad_total, <span class="at">lag_max =</span> <span class="dv">180</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="precipitation" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="precipitation"><span class="header-section-number">3.3</span> Precipitation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">autoplot</span>(precip_total_mm) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Precip (mm)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Seasonality</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">gg_season</span>(precip_total_mm) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Precip (mm)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Autocorrelation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(precip_total_mm, <span class="at">lag_max =</span> <span class="dv">180</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="qa-workflow" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> QA workflow</h1>
<ol start="0" type="1">
<li><p>Choose and validate models for each variable (see <a href="#sec-forecasting">Section&nbsp;5</a>)</p></li>
<li><p>Fit model to all data but most recent day</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>sol_hist <span class="ot">&lt;-</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sol_rad_total) <span class="sc">|&gt;</span> </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datetime <span class="sc">&lt;</span> <span class="fu">max</span>(datetime))</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>sol_new <span class="ot">&lt;-</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sol_rad_total) <span class="sc">|&gt;</span> </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(datetime <span class="sc">==</span> <span class="fu">max</span>(datetime))</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>sol_fit <span class="ot">&lt;-</span> <span class="co">#TODO construct for a list of variables </span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  sol_hist <span class="sc">|&gt;</span> </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="at">sol =</span> <span class="fu">SNAIVE</span>(sol_rad_total <span class="sc">~</span> <span class="fu">lag</span>(<span class="st">"1 year"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Forecast to new data</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>sol_fc <span class="ot">&lt;-</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  sol_fit <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(sol_new, <span class="at">bootstrap =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>Check if data is inside prediction intervals</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>flags <span class="ot">&lt;-</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">as_tibble</span>(sol_new), <span class="fu">as_tibble</span>(sol_fc <span class="sc">|&gt;</span> <span class="fu">hilo</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>sol_rad_total))) <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make an outlier for testing</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sol_rad_total =</span> <span class="fu">if_else</span>(meta_station_id <span class="sc">==</span> <span class="st">"az01"</span>, <span class="dv">10</span>, sol_rad_total)) <span class="sc">|&gt;</span> </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">outlier =</span> <span class="fu">if_else</span>(sol_rad_total <span class="sc">&lt;</span> <span class="st">`</span><span class="at">80%</span><span class="st">`</span><span class="sc">$</span>lower <span class="sc">|</span> sol_rad_total <span class="sc">&gt;</span> <span class="st">`</span><span class="at">80%</span><span class="st">`</span><span class="sc">$</span>upper,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"sol_rad_total"</span>,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                      <span class="cn">NA_character_</span>),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">extreme =</span> <span class="fu">if_else</span>(sol_rad_total <span class="sc">&lt;</span> <span class="st">`</span><span class="at">95%</span><span class="st">`</span><span class="sc">$</span>lower <span class="sc">|</span> sol_rad_total <span class="sc">&gt;</span> <span class="st">`</span><span class="at">95%</span><span class="st">`</span><span class="sc">$</span>upper,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"sol_rad_total"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                      <span class="cn">NA_character_</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">|&gt;</span> </span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(meta_station_id, meta_station_name, datetime, sol_rad_total, outlier, extreme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = c("datetime", "meta_station_id", "meta_station_name")</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>flags</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  meta_station_id meta_station_name datetime   sol_rad_total outlier     extreme
  &lt;chr&gt;           &lt;chr&gt;             &lt;date&gt;             &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;  
1 az01            Tucson            2022-10-25          10   sol_rad_to… &lt;NA&gt;   
2 az06            Maricopa          2022-10-25          17.8 &lt;NA&gt;        &lt;NA&gt;   
3 az07            Aguila            2022-10-25          17.6 &lt;NA&gt;        &lt;NA&gt;   
4 az23            Harquahala        2022-10-25          17.0 &lt;NA&gt;        &lt;NA&gt;   </code></pre>
</div>
</div>
<ol start="4" type="1">
<li>Join back into data??</li>
</ol>
<p>Here we’d need to deal with the possibility of multiple flags per observation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(daily_ts_sub, flags, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"meta_station_id"</span>, <span class="st">"meta_station_name"</span>, <span class="st">"datetime"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(datetime)) <span class="sc">|&gt;</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(outlier, extreme, <span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by `meta_station_id`, `meta_station_name`, `datetime` first.
Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by `meta_station_id`, `meta_station_name`, `datetime` first.
Current temporal ordering may yield unexpected results.
ℹ Suggest to sort by `meta_station_id`, `meta_station_name`, `datetime` first.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 28,952 x 72 [1D]
# Key:       meta_station_id, meta_station_name [4]
   outlier    extreme date_…¹ date_…² datetime   temp_…³ temp_…⁴ temp_…⁵ relat…⁶
   &lt;chr&gt;      &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 sol_rad_t… &lt;NA&gt;       2022     298 2022-10-25    24.7     2.1    13.2      89
 2 &lt;NA&gt;       &lt;NA&gt;       2022     298 2022-10-25    24.6     5.6    14.7      81
 3 &lt;NA&gt;       &lt;NA&gt;       2022     298 2022-10-25    24.6     4      13.5      63
 4 &lt;NA&gt;       &lt;NA&gt;       2022     298 2022-10-25    25.2     3.7    14.3      82
 5 &lt;NA&gt;       &lt;NA&gt;       2022     297 2022-10-24    19.4     6.3    14.2      66
 6 &lt;NA&gt;       &lt;NA&gt;       2022     297 2022-10-24    21.6    10.4    15.6      54
 7 &lt;NA&gt;       &lt;NA&gt;       2022     297 2022-10-24    20       6.8    13        49
 8 &lt;NA&gt;       &lt;NA&gt;       2022     297 2022-10-24    23.8     8.6    15.4      46
 9 &lt;NA&gt;       &lt;NA&gt;       2022     296 2022-10-23    23.9    14.5    19.7      86
10 &lt;NA&gt;       &lt;NA&gt;       2022     296 2022-10-23    24.9    17.4    20.7      77
# … with 28,942 more rows, 63 more variables: relative_humidity_min &lt;dbl&gt;,
#   relative_humidity_mean &lt;dbl&gt;, vp_deficit_mean &lt;dbl&gt;, sol_rad_total.x &lt;dbl&gt;,
#   precip_total_mm &lt;dbl&gt;, temp_soil_10cm_maxC &lt;dbl&gt;,
#   temp_soil_10cm_minC &lt;dbl&gt;, temp_soil_10cm_meanC &lt;dbl&gt;,
#   temp_soil_50cm_maxC &lt;dbl&gt;, temp_soil_50cm_minC &lt;dbl&gt;,
#   temp_soil_50cm_meanC &lt;dbl&gt;, wind_spd_mean_mps &lt;dbl&gt;,
#   wind_vector_magnitude &lt;dbl&gt;, wind_vector_dir &lt;dbl&gt;, …</code></pre>
</div>
</div>
</section>
<section id="sec-forecasting" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Learning about forecasting</h1>
<section id="timeseries-decomposition" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="timeseries-decomposition"><span class="header-section-number">5.1</span> Timeseries decomposition</h2>
<p>Timeseries decomposition doesn’t work when there is missing data. There are <code>NA</code>s for Harquahala and Bowie stations, so I guess I’ll have to omit those until I figure out how to do this with missing data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(sol_rad_total))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 22 x 69 [1D]
# Key:       meta_station_id, meta_station_name [2]
   date_year date_doy datetime   temp_…¹ temp_…² temp_…³ relat…⁴ relat…⁵ relat…⁶
       &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1      2016      357 2016-12-22    NA      NA        NA      NA      NA      NA
 2      2016      358 2016-12-23    NA      NA        NA      NA      NA      NA
 3      2016      359 2016-12-24    NA      NA        NA      NA      NA      NA
 4      2016      360 2016-12-25    NA      NA        NA      NA      NA      NA
 5      2016      361 2016-12-26    NA      NA        NA      NA      NA      NA
 6      2017        1 2017-01-01    12.7     4.4      NA      NA      NA      NA
 7      2017        2 2017-01-02    11.9     4.6      NA      NA      NA      NA
 8      2017        3 2017-01-03    13       1.2      NA      NA      NA      NA
 9      2017        5 2017-01-05    NA      NA        NA      NA      NA      NA
10      2017        6 2017-01-06    NA      NA        NA      NA      NA      NA
# … with 12 more rows, 60 more variables: vp_deficit_mean &lt;dbl&gt;,
#   sol_rad_total &lt;dbl&gt;, precip_total_mm &lt;dbl&gt;, temp_soil_10cm_maxC &lt;dbl&gt;,
#   temp_soil_10cm_minC &lt;dbl&gt;, temp_soil_10cm_meanC &lt;dbl&gt;,
#   temp_soil_50cm_maxC &lt;dbl&gt;, temp_soil_50cm_minC &lt;dbl&gt;,
#   temp_soil_50cm_meanC &lt;dbl&gt;, wind_spd_mean_mps &lt;dbl&gt;,
#   wind_vector_magnitude &lt;dbl&gt;, wind_vector_dir &lt;dbl&gt;,
#   wind_vector_dir_stand_dev &lt;dbl&gt;, wind_spd_max_mps &lt;dbl&gt;, eto_azmet &lt;dbl&gt;, …</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dcmp <span class="ot">&lt;-</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_id <span class="sc">==</span> <span class="fu">first</span>(meta_station_id)) <span class="sc">|&gt;</span> <span class="co">#just use one station for now</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="at">stl =</span> <span class="fu">STL</span>(sol_rad_total <span class="sc">~</span> <span class="fu">season</span>(<span class="st">"1_year"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"az01"</span>, <span class="st">"az06"</span>))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span>(dcmp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dable: 7,238 x 9 [1D]
# Key:     meta_station_id, meta_station_name, .model [1]
# :        sol_rad_total = trend + season_1_year + remainder
   meta_statio…¹ meta_…² .model datetime   sol_r…³ trend seaso…⁴ remai…⁵ seaso…⁶
   &lt;chr&gt;         &lt;chr&gt;   &lt;chr&gt;  &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 az01          Tucson  stl    2003-01-01   12.4   19.3   -8.52   1.58     20.9
 2 az01          Tucson  stl    2003-01-02   12.7   19.3   -8.07   1.49     20.8
 3 az01          Tucson  stl    2003-01-03   12.7   19.3   -9.00   2.40     21.7
 4 az01          Tucson  stl    2003-01-04   12.7   19.3   -8.72   2.10     21.4
 5 az01          Tucson  stl    2003-01-05   12.6   19.3   -8.26   1.53     20.8
 6 az01          Tucson  stl    2003-01-06    6.86  19.3  -10.4   -2.09     17.2
 7 az01          Tucson  stl    2003-01-07   12.0   19.3   -8.87   1.51     20.8
 8 az01          Tucson  stl    2003-01-08    7.41  19.3   -9.26  -2.64     16.7
 9 az01          Tucson  stl    2003-01-09   12.1   19.3   -7.52   0.295    19.6
10 az01          Tucson  stl    2003-01-10   12.7   19.3   -7.73   1.12     20.4
# … with 7,228 more rows, and abbreviated variable names ¹​meta_station_id,
#   ²​meta_station_name, ³​sol_rad_total, ⁴​season_1_year, ⁵​remainder,
#   ⁶​season_adjust</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span>(dcmp) <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(sol_rad_total, <span class="at">color =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>meta_station_id <span class="sc">+</span> meta_station_name, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> trend, <span class="at">color =</span> <span class="st">"trend"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span>(dcmp) <span class="sc">|&gt;</span> <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="timeseries-features" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="timeseries-features"><span class="header-section-number">5.2</span> Timeseries Features</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">features</span>(sol_rad_total, <span class="fu">list</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> \(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  meta_station_id meta_station_name  mean
  &lt;chr&gt;           &lt;chr&gt;             &lt;dbl&gt;
1 az01            Tucson             20.3
2 az07            Aguila             20.5
3 az23            Harquahala         20.5
4 az06            Maricopa           20.6</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">features</span>(sol_rad_total, feat_acf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
  meta_station_id meta_sta…¹  acf1 acf10 diff1…² diff1…³ diff2…⁴ diff2…⁵ seaso…⁶
  &lt;chr&gt;           &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 az01            Tucson     0.827  5.63  -0.342   0.130  -0.592   0.358   0.733
2 az06            Maricopa   0.876  6.71  -0.334   0.126  -0.585   0.347   0.809
3 az07            Aguila     0.867  6.48  -0.346   0.133  -0.590   0.355   0.793
4 az23            Harquahala 0.876  6.77  -0.341   0.133  -0.580   0.341   0.816
# … with abbreviated variable names ¹​meta_station_name, ²​diff1_acf1,
#   ³​diff1_acf10, ⁴​diff2_acf1, ⁵​diff2_acf10, ⁶​season_acf1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">features</span>(sol_rad_total, feat_stl) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 11
  meta_station…¹ meta_…² trend…³ seaso…⁴ seaso…⁵ seaso…⁶ spiki…⁷ linea…⁸ curva…⁹
  &lt;chr&gt;          &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 az01           Tucson    0.858   0.213       6       3 4.37e-6   16.4    20.0 
2 az06           Marico…   0.899   0.214       2       4 2.98e-6    4.06    2.25
3 az07           Aguila    0.894   0.210       6       5 7.44e-6  -18.0   -20.1 
4 az23           Harqua…   0.904   0.211       1       3 6.13e-6    9.46   -4.60
# … with 2 more variables: stl_e_acf1 &lt;dbl&gt;, stl_e_acf10 &lt;dbl&gt;, and abbreviated
#   variable names ¹​meta_station_id, ²​meta_station_name, ³​trend_strength,
#   ⁴​seasonal_strength_week, ⁵​seasonal_peak_week, ⁶​seasonal_trough_week,
#   ⁷​spikiness, ⁸​linearity, ⁹​curvature</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#can't figure out how to set period correctly</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">features</span>(sol_rad_total, <span class="at">features =</span> <span class="fu">list</span>(\(x) <span class="fu">feat_stl</span>(x, <span class="at">.period =</span> <span class="st">"1 year"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 4 errors (1 unique) encountered for feature 1
[4] non-numeric argument to binary operator</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  meta_station_id meta_station_name
  &lt;chr&gt;           &lt;chr&gt;            
1 az01            Tucson           
2 az06            Maricopa         
3 az07            Aguila           
4 az23            Harquahala       </code></pre>
</div>
</div>
</section>
<section id="timeseries-models" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="timeseries-models"><span class="header-section-number">5.3</span> Timeseries Models</h2>
<p>Train a model. IN this case, a simple timeseries linear model (TSLM)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fit_tslm <span class="ot">&lt;-</span> daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">TSLM</span>(sol_rad_total<span class="sc">~</span> <span class="fu">trend</span>())) </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>fit_tslm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A mable: 4 x 3
# Key:     meta_station_id, meta_station_name [4]
  meta_station_id meta_station_name `TSLM(sol_rad_total ~ trend())`
  &lt;chr&gt;           &lt;chr&gt;                                     &lt;model&gt;
1 az01            Tucson                                     &lt;TSLM&gt;
2 az06            Maricopa                                   &lt;TSLM&gt;
3 az07            Aguila                                     &lt;TSLM&gt;
4 az23            Harquahala                                 &lt;TSLM&gt;</code></pre>
</div>
</div>
<p>A slightly fancier model: seasonal naïve</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fit_snaive <span class="ot">&lt;-</span> daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">SNAIVE</span>(sol_rad_total <span class="sc">~</span> <span class="fu">lag</span>(<span class="st">"1 year"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fit_snaive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A mable: 4 x 3
# Key:     meta_station_id, meta_station_name [4]
  meta_station_id meta_station_name `SNAIVE(sol_rad_total ~ lag("1 year"))`
  &lt;chr&gt;           &lt;chr&gt;                                             &lt;model&gt;
1 az01            Tucson                                           &lt;SNAIVE&gt;
2 az06            Maricopa                                         &lt;SNAIVE&gt;
3 az07            Aguila                                           &lt;SNAIVE&gt;
4 az23            Harquahala                                       &lt;SNAIVE&gt;</code></pre>
</div>
</div>
<p>A model including timeseries decomposition:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fit_dcmp <span class="ot">&lt;-</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="at">stlf =</span> <span class="fu">decomposition_model</span>(</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(sol_rad_total <span class="sc">~</span> <span class="fu">season</span>(<span class="at">period =</span> <span class="st">"1 year"</span>)),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">NAIVE</span>(season_adjust)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 1 error encountered for dcmp
[1] promise already under evaluation: recursive default argument reference or earlier problems?

1 error encountered for dcmp
[1] promise already under evaluation: recursive default argument reference or earlier problems?</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 2 errors (1 unique) encountered for stlf
[2] Problem while computing `cmp = map(.fit, components)`.</code></pre>
</div>
</div>
</section>
<section id="forecasting-methods" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="forecasting-methods"><span class="header-section-number">5.4</span> Forecasting methods</h2>
<p>Produce forecasts</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>fit_tslm <span class="sc">|&gt;</span> <span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"3 months"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A fable: 364 x 6 [1D]
# Key:     meta_station_id, meta_station_name, .model [4]
   meta_station_id meta_station_name .model           datetime   sol_rad…¹ .mean
   &lt;chr&gt;           &lt;chr&gt;             &lt;chr&gt;            &lt;date&gt;        &lt;dist&gt; &lt;dbl&gt;
 1 az01            Tucson            TSLM(sol_rad_to… 2022-10-26 N(21, 48)  20.7
 2 az01            Tucson            TSLM(sol_rad_to… 2022-10-27 N(21, 48)  20.7
 3 az01            Tucson            TSLM(sol_rad_to… 2022-10-28 N(21, 48)  20.7
 4 az01            Tucson            TSLM(sol_rad_to… 2022-10-29 N(21, 48)  20.7
 5 az01            Tucson            TSLM(sol_rad_to… 2022-10-30 N(21, 48)  20.7
 6 az01            Tucson            TSLM(sol_rad_to… 2022-10-31 N(21, 48)  20.7
 7 az01            Tucson            TSLM(sol_rad_to… 2022-11-01 N(21, 48)  20.7
 8 az01            Tucson            TSLM(sol_rad_to… 2022-11-02 N(21, 48)  20.7
 9 az01            Tucson            TSLM(sol_rad_to… 2022-11-03 N(21, 48)  20.7
10 az01            Tucson            TSLM(sol_rad_to… 2022-11-04 N(21, 48)  20.7
# … with 354 more rows, and abbreviated variable name ¹​sol_rad_total</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>fit_tslm <span class="sc">|&gt;</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"3 months"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_name <span class="sc">==</span> <span class="st">"Tucson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(datetime)<span class="sc">&gt;</span><span class="dv">2021</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>A very bad forecast because there is no trend here.</p>
<p>What about “seasonal naïve”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fit_snaive <span class="sc">|&gt;</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"1 month"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_name <span class="sc">==</span> <span class="st">"Tucson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(datetime)<span class="sc">&gt;</span><span class="dv">2021</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>OOf, those prediction inteverals are WIDE.</p>
<p>Check residuals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(fit_snaive) <span class="sc">|&gt;</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(.innov)) <span class="sc">+</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1482 rows containing non-finite values (stat_bin).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>residuals are leptokurtic and should be normal!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(fit_snaive) <span class="sc">|&gt;</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(.innov) <span class="sc">|&gt;</span> <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>residuals are autocorrelated and they shouldn’t be!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>fit_snaive <span class="sc">|&gt;</span> <span class="fu">filter</span>(meta_station_id <span class="sc">==</span> <span class="st">"az01"</span>) <span class="sc">|&gt;</span> <span class="fu">gg_tsresiduals</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 365 row(s) containing missing values (geom_path).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 365 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 365 rows containing non-finite values (stat_bin).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Could use bootstrapped residuals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> fit_snaive <span class="sc">|&gt;</span> <span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"1 month"</span>, <span class="at">bootstrap =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>fc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A fable: 120 x 6 [1D]
# Key:     meta_station_id, meta_station_name, .model [4]
   meta_station_id meta_station_name .model        datetime   sol_rad_to…¹ .mean
   &lt;chr&gt;           &lt;chr&gt;             &lt;chr&gt;         &lt;date&gt;           &lt;dist&gt; &lt;dbl&gt;
 1 az01            Tucson            "SNAIVE(sol_… 2022-10-26 sample[5000]  16.6
 2 az01            Tucson            "SNAIVE(sol_… 2022-10-27 sample[5000]  18.1
 3 az01            Tucson            "SNAIVE(sol_… 2022-10-28 sample[5000]  18.1
 4 az01            Tucson            "SNAIVE(sol_… 2022-10-29 sample[5000]  17.8
 5 az01            Tucson            "SNAIVE(sol_… 2022-10-30 sample[5000]  17.1
 6 az01            Tucson            "SNAIVE(sol_… 2022-10-31 sample[5000]  16.7
 7 az01            Tucson            "SNAIVE(sol_… 2022-11-01 sample[5000]  16.5
 8 az01            Tucson            "SNAIVE(sol_… 2022-11-02 sample[5000]  15.3
 9 az01            Tucson            "SNAIVE(sol_… 2022-11-03 sample[5000]  17.0
10 az01            Tucson            "SNAIVE(sol_… 2022-11-04 sample[5000]  16.8
# … with 110 more rows, and abbreviated variable name ¹​sol_rad_total</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>fc <span class="sc">|&gt;</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_name <span class="sc">==</span> <span class="st">"Tucson"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(datetime)<span class="sc">&gt;</span><span class="dv">2021</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Can do forecasting after decomposition</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>fit_dcmp <span class="sc">|&gt;</span> </span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">h =</span> <span class="st">"1 month"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_id <span class="sc">==</span>  <span class="st">"az01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(daily_ts_sub <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(datetime)<span class="sc">&gt;</span><span class="dv">2021</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>fit_dcmp <span class="sc">|&gt;</span> <span class="fu">filter</span>(meta_station_id <span class="sc">==</span> <span class="st">"az01"</span>) <span class="sc">|&gt;</span> <span class="fu">gg_tsresiduals</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 365 row(s) containing missing values (geom_path).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 365 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 365 rows containing non-finite values (stat_bin).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Better??</p>
<p>Let’s find out</p>
</section>
<section id="modelforecast-diagnostics" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="modelforecast-diagnostics"><span class="header-section-number">5.5</span> Model/forecast diagnostics</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>sol_rad_train <span class="ot">&lt;-</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_id <span class="sc">==</span> <span class="st">"az01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(datetime) <span class="sc">&lt;</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span> </span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sol_rad_total)</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>sol_rad_test <span class="ot">&lt;-</span> </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  daily_ts_sub <span class="sc">|&gt;</span> </span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(meta_station_id <span class="sc">==</span> <span class="st">"az01"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(datetime) <span class="sc">&gt;=</span> <span class="dv">2022</span>) <span class="sc">|&gt;</span> </span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sol_rad_total)</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>fit_compare <span class="ot">&lt;-</span> </span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>  sol_rad_train <span class="sc">|&gt;</span> </span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">MEAN</span>(sol_rad_total),</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">naive =</span> <span class="fu">NAIVE</span>(sol_rad_total),</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">snaive =</span> <span class="fu">SNAIVE</span>(sol_rad_total <span class="sc">~</span> <span class="fu">lag</span>(<span class="st">"1 year"</span>)),</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">drift =</span> <span class="fu">RW</span>(sol_rad_total <span class="sc">~</span> <span class="fu">drift</span>()),</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">stlf =</span> <span class="fu">decomposition_model</span>(</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">STL</span>(sol_rad_total <span class="sc">~</span> <span class="fu">season</span>(<span class="at">period =</span> <span class="st">"1 year"</span>)),</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">NAIVE</span>(season_adjust)</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> fit_compare <span class="sc">|&gt;</span> <span class="fu">forecast</span>(sol_rad_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.
Non-integer lag orders for random walk models are not supported. Rounding to the nearest integer.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>fc <span class="sc">|&gt;</span> </span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="fu">bind_rows</span>(sol_rad_train, sol_rad_test) <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">year</span>(datetime)<span class="sc">&gt;=</span><span class="dv">2021</span>), <span class="at">level =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="azmet-qaqc_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(fc, sol_rad_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 10
  .model .type     ME  RMSE   MAE    MPE  MAPE  MASE RMSSE  ACF1
  &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 drift  Test  15.4   16.5  15.4  64.7    64.9   NaN   NaN 0.775
2 mean   Test   2.32   6.53  5.47  0.533  27.4   NaN   NaN 0.774
3 naive  Test  15.3   16.4  15.3  64.2    64.4   NaN   NaN 0.774
4 snaive Test   0.135  5.06  3.40 -4.01   19.2   NaN   NaN 0.311
5 stlf   Test   3.97   5.64  5.12 15.0    25.1   NaN   NaN 0.368</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">#winkler score evaluates prediction interval accuracy</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="fu">accuracy</span>(fc, sol_rad_test, <span class="fu">list</span>(<span class="at">winkler =</span> winkler_score), <span class="at">level =</span> <span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .model .type winkler
  &lt;chr&gt;  &lt;chr&gt;   &lt;dbl&gt;
1 drift  Test    123. 
2 mean   Test     21.4
3 naive  Test    121. 
4 snaive Test     19.5
5 stlf   Test    109. </code></pre>
</div>
</div>
<p>best method here is seasonal naive</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>